{% extends "TecnocreacionesVzlaGovernmentBundle:Template:Developer/base.html.twig" %}

{% trans_default_domain 'TecnocreacionesVzlaGovernmentBundle' %}

{% block stylesheets %}
        <!-- Additional styles -->
        <link rel="stylesheet" href="{{ asset('bundles/tecnocreacionesvzlagovernment/template/developer/css/styles/switches3860.css?v=1') }}">

        <!-- Login pages styles -->
        <link rel="stylesheet" media="screen" href="{{ asset('bundles/tecnocreacionesvzlagovernment/template/developer/css/login3860.css?v=1') }}">

        {% stylesheets  
            '@TecnocreacionesVzlaGovernmentBundle/Resources/assets/css/login.css'
            '@TecnocreacionesVzlaGovernmentBundle/Resources/assets/css/gobierno-vzla.css'
            output='compiled/login_sigtec.min.css' 
            filter='uglifycss' filter='cssrewrite'
        %}
            <link rel="stylesheet" href="{{ asset_url }}" />
        {% endstylesheets %}
        {% set logo = templateConfig.getTemplateOption('developer','logo') %}
        <style>
            .form-door div {
		background: url({{ asset(logo['login_watermark']) }}) no-repeat center top;
            }
        </style>
{% endblock stylesheets %}

{% block content %}
        <div class="block main-container">
            {% include 'TecnocreacionesVzlaGovernmentBundle:Block:header.html.twig' %}
            {% block box_top %}
                <br />
                <div class="with-padding">
                    <p>{{ 'tecnocreaciones_vzla_government.message_app_title'|trans }}</p>
                </div>
            {% endblock box_top %}
            {% block sub_content %}
            <div id="login-container">
                <div id="form-wrapper">
                    <div id="form-block" class="scratch-metal">
                        <div id="form-viewport">
                            {% block form_viewport %}
                                <form method="post" action="#" id="form-login" class="input-wrapper blue-gradient glossy" title="{{ 'tecnocreaciones_vzla_government.sign_in'|trans }}">
                                    {% block form_login %}
                                    <ul class="inputs black-input large">
                                        <!-- The autocomplete="off" attributes is the only way to prevent webkit browsers from filling the inputs with yellow -->
                                        <li><span class="icon-user mid-margin-right"></span><input type="text" name="login" id="login" value="" class="input-unstyled" placeholder="{{ 'tecnocreaciones_vzla_government.username'|trans }}" autocomplete="off"></li>
                                        <li><span class="icon-lock mid-margin-right"></span><input type="password" name="pass" id="pass" value="" class="input-unstyled" placeholder="{{ 'tecnocreaciones_vzla_government.password'|trans }}" autocomplete="off"></li>
                                    </ul>

                                    <p class="button-height">
                                        <button type="submit" class="button glossy float-right" id="login">{{ 'tecnocreaciones_vzla_government.sign_in'|trans }}</button>
                                        <input type="checkbox" name="_remember_me" id="remember_me" checked="checked" class="switch tiny mid-margin-right with-tooltip" title="{{ 'tecnocreaciones_vzla_government.enable_auto_login'|trans }}">
                                        <label for="remember_me">{{ 'tecnocreaciones_vzla_government.remind_me'|trans }}</label>
                                    </p>
                                    {% endblock form_login %}
                                </form>

                                <form method="post" action="#" id="form-password" class="input-wrapper orange-gradient glossy" title="{{ 'tecnocreaciones_vzla_government.lost_password'|trans }}">
                                    {% block form_remember_password %}
                                        <p class="message">
                                            {{ 'tecnocreaciones_vzla_government.message_remember_password'|trans }}:
                                            <span class="block-arrow"><span></span></span>
                                        </p>

                                        <ul class="inputs black-input large">
                                            <li><span class="icon-mail mid-margin-right"></span><input type="email" name="mail" id="mail" value="" class="input-unstyled" placeholder="{{ 'tecnocreaciones_vzla_government.your_email'|trans }}" autocomplete="off"></li>
                                        </ul>
                                    {% endblock form_remember_password %}
                                    <button type="submit" class="button glossy full-width" id="send-password">{{ 'tecnocreaciones_vzla_government.send_instructions'|trans }}</button>

                                </form>

                                <form method="post" action="#" id="form-register" class="input-wrapper red-gradient glossy" title="{{ 'tecnocreaciones_vzla_government.registration'|trans }}">
                                    {% block form_register %}
                                        <p class="message">
                                            {{ 'tecnocreaciones_vzla_government.message_register'|trans }}:
                                            <span class="block-arrow"><span></span></span>
                                        </p>

                                        <ul class="inputs black-input large">
                                            <li><span class="icon-card mid-margin-right"></span><input type="text" name="name" id="name-register" value="" class="input-unstyled" placeholder="{{ 'tecnocreaciones_vzla_government.your_name'|trans }}" autocomplete="off"></li>
                                            <li><span class="icon-mail mid-margin-right"></span><input type="email" name="mail" id="mail-register" value="" class="input-unstyled" placeholder="{{ 'tecnocreaciones_vzla_government.your_email'|trans }}" autocomplete="off"></li>
                                        </ul>
                                        <ul class="inputs black-input large">
                                            <li><span class="icon-user mid-margin-right"></span><input type="text" name="login" id="login-register" value="" class="input-unstyled" placeholder="{{ 'tecnocreaciones_vzla_government.username'|trans }}" autocomplete="off"></li>
                                            <li><span class="icon-lock mid-margin-right"></span><input type="password" name="pass" id="pass-register" value="" class="input-unstyled" placeholder="{{ 'tecnocreaciones_vzla_government.password'|trans }}" autocomplete="off"></li>
                                        </ul>
                                    {% endblock form_register %}
                                    <button type="submit" class="button glossy full-width" id="send-register">{{ 'tecnocreaciones_vzla_government.register'|trans }}</button>
                                </form>
                            {% endblock form_viewport %}
                        </div>
                    </div>
                    {% block box_bottom '' %}
                </div>
            </div>
            {% endblock sub_content %}
            {% include 'TecnocreacionesVzlaGovernmentBundle:Block:footer.html.twig' %}
        </div>
{% endblock %}



{% block javascripts %}
    {{ parent() }}
    {% javascripts
        'bundles/tecnocreacionesvzlagovernment/template/developer/js/developr.message.js'
        'bundles/bazingajstranslation/js/translator.min.js'
        
        filter='?uglifyjs2'
        output='compiled/javascript_login_sigtec.min.js'
    %}
        <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
    {# Traductor #}
    <script src="{{ url('bazinga_jstranslation_js') }}"></script>
{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        $.fn.styleSelect.defaults.allValuesText = '{{ 'tecnocreaciones_vzla_government.all'|trans }}';
        $.fn.styleSelect.defaults.multipleValuesText = '%d {{ 'tecnocreaciones_vzla_government.selected'|trans }}';
        $.fn.styleSelect.defaults.searchText = '{{ 'tecnocreaciones_vzla_government.search'|trans }}';
    </script>
    <script>

            /*
             * How do I hook my login script to these?
             * --------------------------------------
             *
             * These scripts are meant to be non-obtrusive: if the user has disabled javascript or if an error occurs, the forms
             * works fine without ajax.
             *
             * The only part you need to edit are the scripts between the EDIT THIS SECTION tags, which do inputs validation and
             * send data to server. For instance, you may keep the validation and add an AJAX call to the server with the user
             * input, then redirect to the dashboard or display an error depending on server return.
             *
             * Or if you don't trust AJAX calls, just remove the event.preventDefault() part and let the form be submitted.
             */

            $(document).ready(function()
            {
                /*
                 * JS login effect
                 * This script will enable effects for the login page
                 */
                // Elements
                var doc = $('html').addClass('js-login'),
                        container = $('#container'),
                        formWrapper = $('#form-wrapper'),
                        formBlock = $('#form-block'),
                        formViewport = $('#form-viewport'),
                        forms = formViewport.children('form'),
                        // Doors
                        topDoor = $('<div id="top-door" class="form-door"><div></div></div>').appendTo(formViewport),
                        botDoor = $('<div id="bot-door" class="form-door"><div></div></div>').appendTo(formViewport),
                        doors = topDoor.add(botDoor),
                        // Switch
                        formSwitch = $('<div id="form-switch"><span class="button-group"></span></div>').appendTo(formBlock).children(),
                        // Current form
                        hash = (document.location.hash.length > 1) ? document.location.hash.substring(1) : false,
                        // If layout is centered
                        centered,
                        // Store current form
                        currentForm,
                        // Animation interval
                        animInt,
                        // Work vars
                        maxHeight = false,
                        blocHeight;

                /******* EDIT THIS SECTION *******/

                /*
                 * Login
                 * These functions will handle the login process through AJAX
                 */
                $('#form-login').submit(function(event)
                {
                    // Values
                    var login = $.trim($('#login').val()),
                            pass = $.trim($('#pass').val()),remind = $.trim($('#remember_me').val());

                    // Stop normal behavior
                    event.preventDefault();

                    // Check inputs
                    if (login.length === 0)
                    {
                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_login'|trans }}');
                        return false;
                    }
                    else if (pass.length === 0)
                    {
                        // Remove empty login message if displayed
                        formWrapper.clearMessages('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_login'|trans }}');

                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_password'|trans }}');
                        return false;
                    }
                    else
                    {
                        // Remove previous messages
                        formWrapper.clearMessages();

                        // Show progress
                        displayLoading('{{ 'tecnocreaciones_vzla_government.login.validators.checking_credentials'|trans }}...');

                        var url = '{{ path("fos_user_security_check") }}';
                        
                        if($("#remember_me").is(':checked')) {  
                            remind = 'on';
                        } else {  
                            remind = 'off';
                        }  
                        
                        //This is where you may do your AJAX call, for instance:
                        $.ajax(url, {
                            type: "POST",
                            data: {
                                _username: login,
                                _password: pass,
                                _remember_me: remind,
                                _csrf_token: '{{ csrf_token }}'
                            },
                            success: function(data)
                            {
                                if (data.url) {
                                    document.location.href = data.url;
                                } else {
                                    formWrapper.clearMessages();
                                }
                            },
                            error: function(response)
                            {
                                var data = jQuery.parseJSON(response.responseText);
                                formWrapper.clearMessages();
                                displayError(data.message);
                            }
                        });
                    }
                });

                /*
                 * Password recovery
                 */
                $('#form-password').submit(function(event)
                {
                    // Values
                    var mail = $.trim($('#mail').val());

                    // Stop normal behavior
                    event.preventDefault();

                    // Check inputs
                    if (mail.length === 0)
                    {
                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_email'|trans }}');
                    }
                    // Want more robust mail validation? see http://stackoverflow.com/a/2855946
                    else if (!/^[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/.test(mail))
                    {
                        // Remove empty email message if displayed
                        formWrapper.clearMessages('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_email'|trans }}');

                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.email_is_not_valid'|trans }}');
                        return false;
                    }
                    else
                    {
                        // Remove previous messages
                        formWrapper.clearMessages();

                        // Show progress
                        displayLoading('{{ 'tecnocreaciones_vzla_government.login.validators.sending_instructions'|trans }}...');

                        /*
                         * This is where you may do your AJAX call
                         */
                        var url = '{{ path("fos_user_resetting_send_email") }}';
                        //This is where you may do your AJAX call, for instance:
                        $.ajax(url, {
                            type: "POST",
                            data: {
                                username: mail
                            },
                            success: function(data)
                            {
                                formWrapper.clearMessages();
                                displaySuccess(data.message);
                            },
                            error: function(response)
                            {
                                var data = jQuery.parseJSON(response.responseText);
                                formWrapper.clearMessages();
                                displayError(data.message);
                            }
                        });
                    }
                });
                {% block submit_form_register %}
                /*
                 * Register
                 */
                $('#form-register').submit(function(event)
                {
                    // Values
                    var name = $.trim($('#name-register').val()),
                            mail = $.trim($('#mail-register').val()),
                            login = $.trim($('#login-register').val()),
                            pass = $.trim($('#pass-register').val());

                    // Remove previous messages
                    formWrapper.clearMessages();

                    // Stop normal behavior
                    event.preventDefault();

                    // Check inputs
                    if (name.length === 0)
                    {
                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_name'|trans }}');
                        return false;
                    }
                    else if (mail.length === 0)
                    {
                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_email'|trans }}');
                        return false;
                    }
                    else if (!/^[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/.test(mail))
                    {
                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.email_is_not_valid'|trans }}');
                        return false;
                    }
                    else if (login.length === 0)
                    {
                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_login'|trans }}');
                        return false;
                    }
                    else if (pass.length === 0)
                    {
                        // Display message
                        displayError('{{ 'tecnocreaciones_vzla_government.login.validators.please_fill_in_your_password'|trans }}');
                        return false;
                    }
                    else
                    {
                        // Show progress
                        displayLoading('{{ 'tecnocreaciones_vzla_government.login.validators.registering'|trans }}...');

                        /*
                         * This is where you may do your AJAX call
                         */
                        var url = '{{ path("fos_user_registration_register") }}';
                        //This is where you may do your AJAX call, for instance:
                        $.ajax(url, {
                            type: "POST",
                            data: {
                                'fos_user_registration_form[firstName]': name,
                                'fos_user_registration_form[email]': mail,
                                'fos_user_registration_form[username]': login,
                                'fos_user_registration_form[plainPassword][first]': pass,
                                'fos_user_registration_form[plainPassword][second]': pass,
                                'fos_user_registration_form[_token]': '{{ csrf_token_register }}',
                                'role': 'client'
                            },
                            success: function(data)
                            {
                                formWrapper.clearMessages();
                                displaySuccess(data.message);
                                if (data.targetUrl != null && data.targetUrl != '') {
                                    //console.log(data.targetUrl);
                                    //console.log(document.location);
                                    //document.location.href = data.targetUrl;
                                }
                            },
                            error: function(response)
                            {
                                var data = jQuery.parseJSON(response.responseText);
                                formWrapper.clearMessages();
                                displayError(data.message);
                                var children = data.errors.children;
                                var i = 0;
                                if (children.email.errors) {
                                    for (i = 0; i < children.email.errors.length; i++) {
                                        displayError(children.email.errors[i]);
                                    }
                                }
                                for (i = 0; i < children.username.errors.length; i++) {
                                    displayError(children.username.errors[i]);
                                }
                            }
                        });
                    }
                });
                
                {% endblock submit_form_register %}

                /******* END OF EDIT SECTION *******/

                /*
                 * Animated login
                 */

                // Prepare forms
                forms.each(function(i)
                {
                    var form = $(this),
                            height = form.outerHeight(),
                            active = (hash === false && i === 0) || (hash === this.id),
                            color = this.className.match(/[a-z]+-gradient/) ? ' ' + (/([a-z]+)-gradient/.exec(this.className)[1]) + '-active' : '';

                    // Store size
                    form.data('height', height);

                    // Min-height for mobile layout
                    if (maxHeight === false || height > maxHeight)
                    {
                        maxHeight = height;
                    }

                    // Button in the switch
                    form.data('button', $('<a href="#' + this.id + '" class="button anthracite-gradient' + color + (active ? ' active' : '') + '">' + this.title + '</a>')
                            .appendTo(formSwitch)
                            .data('form', form));

                    // Remove title to prevent tooltip from showing - thanks efreed :)
                    this.title = '';

                    // If active
                    if (active)
                    {
                        // Store
                        currentForm = form;

                        // Height of viewport
                        formViewport.height(height);
                    }
                    else
                    {
                        // Hide for now
                        form.hide();
                    }
                });

                // Main bloc height (without form height)
                blocHeight = formBlock.height() - currentForm.data('height');

                // Handle resizing (mostly for debugging)
                function handleLoginResize()
                {
                    // Detect mode
                    centered = (container.css('position') === 'absolute');

                    // Set min-height for mobile layout
                    if (!centered)
                    {
                        formWrapper.css('min-height', (blocHeight + maxHeight + 20) + 'px');
                        container.css('margin-top', '');
                    }
                    else
                    {
                        formWrapper.css('min-height', '');
                        if (parseInt(container.css('margin-top'), 10) === 0)
                        {
                            centerForm(currentForm, false);
                        }
                    }
                }
                ;

                // Register and first call
                $(window).bind('normalized-resize', handleLoginResize);
                handleLoginResize();

                // Switch behavior
                formSwitch.on('click', 'a', function(event)
                {
                    var link = $(this),
                            form = link.data('form'),
                            previousForm = currentForm;

                    event.preventDefault();
                    if (link.hasClass('active'))
                    {
                        return;
                    }

                    // Refresh forms sizes
                    forms.each(function(i)
                    {
                        var form = $(this),
                                hidden = form.is(':hidden'),
                                height = form.show().outerHeight();

                        // Store size
                        form.data('height', height);

                        // If not active
                        if (hidden)
                        {
                            // Hide for now
                            form.hide();
                        }
                    });

                    // Clear messages
                    formWrapper.clearMessages();

                    // If an animation is already running
                    if (animInt)
                    {
                        clearTimeout(animInt);
                    }
                    formViewport.stop(true);

                    // Update active button
                    currentForm.data('button').removeClass('active');
                    link.addClass('active');

                    // Set as current
                    currentForm = form;

                    // if CSS transitions are available
                    if (doc.hasClass('csstransitions'))
                    {
                        // Close doors - step 1
                        doors.removeClass('door-closed').addClass('door-down');
                        animInt = setTimeout(function()
                        {
                            // Close doors, step 2
                            doors.addClass('door-closed');
                            animInt = setTimeout(function()
                            {
                                // Hide previous form
                                previousForm.hide();

                                // Show target form
                                form.show();

                                // Center layout
                                centerForm(form, true);

                                // Height of viewport
                                formViewport.animate({
                                    height: form.data('height') + 'px'
                                }, function()
                                {
                                    // Open doors, step 1
                                    doors.removeClass('door-closed');
                                    animInt = setTimeout(function()
                                    {
                                        // Open doors - step 2
                                        doors.removeClass('door-down');
                                    }, 300);
                                });
                            }, 300);
                        }, 300);
                    }
                    else
                    {
                        // Close doors
                        topDoor.animate({top: '0%'}, 300);
                        botDoor.animate({top: '50%'}, 300, function()
                        {
                            // Hide previous form
                            previousForm.hide();

                            // Show target form
                            form.show();

                            // Center layout
                            centerForm(form, true);

                            // Height of viewport
                            formViewport.animate({
                                height: form.data('height') + 'px'
                            }, {
                                /* IE7 is a bit buggy, we must force redraw */
                                step: function(now, fx)
                                {
                                    topDoor.hide().show();
                                    botDoor.hide().show();
                                    formSwitch.hide().show();
                                },
                                complete: function()
                                {
                                    // Open doors
                                    topDoor.animate({top: '-50%'}, 300);
                                    botDoor.animate({top: '105%'}, 300);
                                    formSwitch.hide().show();
                                }
                            });
                        });
                    }
                });

                // Initial vertical adjust
                centerForm(currentForm, false);

                /*
                 * Center function
                 * @param jQuery form the form element whose height will be used
                 * @param boolean animate whether or not to animate the position change
                 * @param string|element|array any jQuery selector, DOM element or set of DOM elements which should be ignored
                 * @return void
                 */
                function centerForm(form, animate, ignore)
                {
                    // If layout is centered
                    if (centered)
                    {
                        var siblings = formWrapper.siblings().not('.closing'),
                                finalSize = blocHeight + form.data('height');

                        // Ignored elements
                        if (ignore)
                        {
                            siblings = siblings.not(ignore);
                        }

                        // Get other elements height
                        siblings.each(function(i)
                        {
                            finalSize += $(this).outerHeight(true);
                        });

                        // Setup
                        container[animate ? 'animate' : 'css']({marginTop: -Math.round(finalSize / 2) + 'px'});
                    }
                }
                ;

                /**
                 * Function to display error messages
                 * @param string message the error to display
                 */
                function displayError(message)
                {
                    // Show message
                    var message = formWrapper.message(Translator.trans(message), {
                        append: false,
                        arrow: 'bottom',
                        classes: ['red-gradient'],
                        animate: false					// We'll do animation later, we need to know the message height first
                    });

                    // Vertical centering (where we need the message height)
                    centerForm(currentForm, true, 'fast');

                    // Watch for closing and show with effect
                    message.bind('endfade', function(event)
                    {
                        // This will be called once the message has faded away and is removed
                        centerForm(currentForm, true, message.get(0));

                    }).hide().slideDown('fast');
                }
                ;

                /**
                 * Function to display error messages
                 * @param string message the error to display
                 */
                function displaySuccess(message)
                {
                    // Show message
                    var message = formWrapper.message(message, {
                        append: false,
                        arrow: 'bottom',
                        classes: ['green-gradient'],
                        animate: false					// We'll do animation later, we need to know the message height first
                    });

                    // Vertical centering (where we need the message height)
                    centerForm(currentForm, true, 'fast');

                    // Watch for closing and show with effect
                    message.bind('endfade', function(event)
                    {
                        // This will be called once the message has faded away and is removed
                        centerForm(currentForm, true, message.get(0));

                    }).hide().slideDown('fast');
                }
                ;

                /**
                 * Function to display loading messages
                 * @param string message the message to display
                 */
                function displayLoading(message)
                {
                    // Show message
                    var message = formWrapper.message('<strong>' + message + '</strong>', {
                        append: false,
                        arrow: 'bottom',
                        classes: ['blue-gradient', 'align-center'],
                        stripes: true,
                        darkStripes: false,
                        closable: false,
                        animate: false					// We'll do animation later, we need to know the message height first
                    });

                    // Vertical centering (where we need the message height)
                    centerForm(currentForm, true, 'fast');

                    // Watch for closing and show with effect
                    message.bind('endfade', function(event)
                    {
                        // This will be called once the message has faded away and is removed
                        centerForm(currentForm, true, message.get(0));

                    }).hide().slideDown('fast');
                }
                ;
                {% block post_init_form '' %}
            });

        </script>
{% endblock javascript %}